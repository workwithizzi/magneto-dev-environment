#!/bin/bash
# Download magneto locally and unzip it in the $MAG_DIR dir
source bin/utils
MAG_DIR=".tmp"

[ -z "$1" ] && print_error "Please specify the version to download (ex. $DEFAULT_MAGENTO_VERSION)" && exit

# If file isn't there, download it
if [ ! -f "$HOME/.docker-magento/magento2-$1.tar.gz" ]; then
		print_doing "Downloading magento2-$1"

		mkdir -p "$HOME/.docker-magento"
		(cd "$HOME/.docker-magento" && curl -OL "http://pubfiles.nexcess.net/magento/ce-packages/magento2-$1.tar.gz")
fi

# Fallback download to hypernode if archive doesn't
# exist on Nexcess (smaller than 1MB)
if [ "$(find "$HOME"/.docker-magento/magento2-"$1".tar.gz -size -1M)" ]; then
		print_doing "Downloading magento2-$1"

		(cd "$HOME/.docker-magento" && curl -o "magento2-$1.tar.gz" -OL "https://www.magento.mirror.hypernode.com/releases/magento-$1.tar.gz")
fi


# If $MAG_DIR/ dir isn't there, unzip and move magento core to directory
if [ ! -d "$MAG_DIR" ]; then
	print_doing "Extracting magento2-$1.tar.gz to '$MAG_DIR'"
	mkdir -p "$MAG_DIR" && tar xzf "$HOME/.docker-magento/magento2-$1.tar.gz" -o -C "$MAG_DIR"

	if [ -d "$MAG_DIR/vendor" ]; then
		print_doing "Removing vendor dependencies from local install"
		rm -rf "$MAG_DIR/vendor"
	fi
else
	echo "‚ùì Looks like you already have a '$MAG_DIR' directory."
	echo "   Do you want to replace it? [y|n]"
	read -r REPLY_REPLACE
	if [[ $REPLY_REPLACE =~ ^[y]$ ]]; then
		print_doing "Replacing contents in $MAG_DIR/ with a fresh install"
		rm -rf "$MAG_DIR"

		mkdir -p "$MAG_DIR" && tar xzf "$HOME/.docker-magento/magento2-$1.tar.gz" -o -C "$MAG_DIR"
	fi
fi