#!/bin/bash
#
source bin/utils
CONTAINER="$CONT_NGINX"

[ -z "$1" ] && print_error "Please specify a domain (ex. mydomain.test)" && exit

# Generate certificate authority if not already setup
if ! docker-compose exec -T -u root "$CONTAINER" cat /root/.local/share/mkcert/rootCA.pem | grep -q 'BEGIN CERTIFICATE'; then
	bin/setup-ssl-ca
fi

print_doing "Generating the certificate for $1"

docker-compose exec -T -u root "$CONTAINER" mkcert -key-file nginx.key -cert-file nginx.crt "$@"
print_doing "Moving key and cert to /etc/nginx/certs/"
docker-compose exec -T -u root "$CONTAINER" chown app:app nginx.key nginx.crt
docker-compose exec -T -u root "$CONTAINER" mv nginx.key nginx.crt /etc/nginx/certs/

# Restart nginx to apply the updates
bin/restart